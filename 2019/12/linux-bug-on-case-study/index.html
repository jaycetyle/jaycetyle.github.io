<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <meta property="og:url" content="https://blog.jaycetyle.com/2019/12/linux-bug-on-case-study/">
  <meta property="og:site_name" content="Jayce çš„å…±äº«è¨˜æ†¶é«”">
  <meta property="og:title" content="Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«">
  <meta property="og:description" content="å‰ä¸€é™£å­æœ‰è¿½è¹¤ä¸€å€‹ ARM å¹³å°ç™¼ç”Ÿ Kernel BUG_ON çš„å•é¡Œï¼Œåœ¨åŒäº‹çš„å”åŠ©ä¸‹èŠ±äº†ä¸€é»æ™‚é–“çµ‚æ–¼è¿½å‡ºå¯èƒ½çš„åŸå› ï¼Œé€™ç¯‡åˆ†äº«å¯¦éš›åˆ†æ Kernel Oops log çš„éç¨‹ï¼Œä»¥åŠç›¸é—œå·¥å…·çš„ä½¿ç”¨æ–¹å¼çµ¦å„ä½åƒè€ƒ">
  <meta property="og:locale" content="zh_tw">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-12-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-02T00:00:00+00:00">
    <meta property="article:tag" content="Linux Kernel">

        
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«">
  <meta name="twitter:description" content="å‰ä¸€é™£å­æœ‰è¿½è¹¤ä¸€å€‹ ARM å¹³å°ç™¼ç”Ÿ Kernel BUG_ON çš„å•é¡Œï¼Œåœ¨åŒäº‹çš„å”åŠ©ä¸‹èŠ±äº†ä¸€é»æ™‚é–“çµ‚æ–¼è¿½å‡ºå¯èƒ½çš„åŸå› ï¼Œé€™ç¯‡åˆ†äº«å¯¦éš›åˆ†æ Kernel Oops log çš„éç¨‹ï¼Œä»¥åŠç›¸é—œå·¥å…·çš„ä½¿ç”¨æ–¹å¼çµ¦å„ä½åƒè€ƒ">


        <title>
  Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº« | Jayce çš„å…±äº«è¨˜æ†¶é«”
</title>

        

<link rel="shortcut icon" href="/images/favicon.ico">

<link rel="shortcut icon" href="/images/favicon.png">

<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">


        <link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">      
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

        
        
        
        
        
        <link rel="stylesheet" href="https://blog.jaycetyle.com/css/styles.min.6a7e3e1c24ad4b4b16f344cfc54f4b5a4e92f35366ada3879f0176264c5f99b9.css" integrity="sha256-an4&#43;HCStS0sW80TPxU9LWk6S81NmraOHnwF2Jkxfmbk=">
        
        
        <link id="theme-style" rel="stylesheet" href="">

        
        <script>
            window.themeUrls = {
            light: "\/css\/light.min.0d91bc92b83a6a8aac989d53ce618ea99f98702fd931a07d8219dd7c3ae030eb.css",
            dark: "\/css\/dark.min.0525e903e45a2f396be49bc8bbb86720ab65a077b0f5913ae72e4e155adf02d8.css"
            };
        </script>
        
  <link rel="me" type="text/html" href="https://www.linkedin.com/in/chieh-lin-569430a9/"/>


<link rel="shortcut icon" href="/images/favicon.ico">

<link rel="shortcut icon" href="/images/favicon.png">

<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">


<link rel="alternate" type="application/rss+xml" href='https://blog.jaycetyle.com/index.xml' />

<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="author" content="" />
<meta name="copyright" content="" />


<meta name="description" content="å‰ä¸€é™£å­æœ‰è¿½è¹¤ä¸€å€‹ ARM å¹³å°ç™¼ç”Ÿ Kernel BUG_ON çš„å•é¡Œï¼Œåœ¨åŒäº‹çš„å”åŠ©ä¸‹èŠ±äº†ä¸€é»æ™‚é–“çµ‚æ–¼è¿½å‡ºå¯èƒ½çš„åŸå› ï¼Œé€™ç¯‡åˆ†äº«å¯¦éš›åˆ†æ Kernel Oops log çš„éç¨‹ï¼Œä»¥åŠç›¸é—œå·¥å…·çš„ä½¿ç”¨æ–¹å¼çµ¦å„ä½åƒè€ƒ">

  <style type="text/css">
  .feature-image {
    background-image: linear-gradient(
      rgba(0, 0, 0, 0.15),
      rgba(0, 0, 0, 0.15)
    ), url('https://blog.jaycetyle.com/images/banner.jpg');
    height: 400px;
    background-repeat:no-repeat;
    background-size:cover;
    background-position: center;
  }
  .feature-image-text {
    margin-top: 20px;
  }

  @media (max-width: 1024px) {
    .feature-image {
      height: 300px;
    }
  }

  @media (max-width: 768px) {
    .feature-image {
      height: 250px;
    }
  }

  @media (max-width: 520px) {
    .feature-image {
      display: none;
    }
  }
</style>




    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-md navbar-primary bg-primary py-1 top-nav">
            <div class="container">
                    <a href="https://blog.jaycetyle.com/"><img class="logo" src="https://blog.jaycetyle.com//images/logo.png"></a>
<a class="navbar-brand pr-4 d-none d-sm-block" href="https://blog.jaycetyle.com/">Jayce&#39;s Shared Memory</a>
                <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars" style="color:black"></i>
                </button>
                <div class="navbar-collapse collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/">Home</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/%20archive/">Archive</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://github.com/jaycetyle">Github</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/%20about/">About</a>
</li>
<button id="theme-toggle" style="background: transparent; border: none; color: inherit; cursor: pointer;">
    ğŸŒ™
</button>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const themeLink = document.getElementById("theme-style");
        const toggleBtn = document.getElementById("theme-toggle");

        function getPreferredTheme() {
            return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }

        function setTheme(theme) {
            themeLink.href = window.themeUrls[theme];
            toggleBtn.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        }

        let currentTheme = getPreferredTheme();
        setTheme(currentTheme);

        toggleBtn.addEventListener("click", function () {
            currentTheme = currentTheme === "dark" ? "light" : "dark";
            setTheme(currentTheme);
        });
    });
</script>
                    </ul>
                </div>
            </div>
        </nav>

        
  <header class="feature-image">
  <div class="feature-image-text white-shadow-text">
    <h1 class="font-weight:bold">Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«</h1>
  </div>
</header>


        <div class="container main my-4">
            
  <div class="post p-3 p-sm-5">
    <h3 class="post-title">Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«</h3>
    <div class="mt-2 mb-3">
    <small>
        <strong>By Lin Chieh (Jayce)</strong>
        | <i class="far fa-calendar-alt"></i>&nbsp;Dec 4, 2019&nbsp;
        | <i class="fa fa-tags" title="Tags" aria-hidden="true"></i> <a href='/tags/linux-kernel/'>Linux Kernel</a>
    </small>
</div>

    <div class="mt-4 mb-4 main-content">
      <p>ã€€ã€€å‰ä¸€é™£å­æœ‰è¿½è¹¤ä¸€å€‹ ARM å¹³å°ç™¼ç”Ÿ Kernel BUG_ON çš„å•é¡Œï¼Œåœ¨åŒäº‹çš„å”åŠ©ä¸‹èŠ±äº†ä¸€é»æ™‚é–“çµ‚æ–¼è¿½å‡ºå¯èƒ½çš„åŸå› ã€‚åœ¨æˆ‘å‰›é–‹å§‹æ¥è§¸ Linux Kernel æ™‚ï¼Œé‡åˆ°é€™é¡ log éƒ½å¾ˆä¸çŸ¥é“è©²å¦‚ä½•ä¸‹æ‰‹ï¼Œç´¯ç©äº†ä¸€äº›ç¶“é©—ä»¥å¾Œæ‰æ…¢æ…¢çŸ¥é“è©²å¦‚ä½•åˆ‡å…¥ã€åˆ†æåŠæ‰¾å‡ºåŸå› ã€‚</p>
<p>ã€€ã€€é€™ç¯‡æœƒåˆ†äº«å¯¦éš›åˆ†æ Kernel Oops log çš„éç¨‹ï¼Œä»¥åŠç›¸é—œå·¥å…·çš„ä½¿ç”¨æ–¹å¼åšç‚ºæ¡ˆä¾‹åˆ†æçµ¦å„ä½åƒè€ƒã€‚</p>
<p>Â </p>
<h3 id="oops">Oops!</h3>
<p>ã€€ã€€é‡åˆ° Kernel panic æˆ– Oops çš„æ™‚å€™ï¼ŒKernel é€šå¸¸æœƒ dump ä¸€äº›è¨Šæ¯å‡ºä¾†ï¼Œå¯ä»¥åœ¨ dmesg æˆ–æ˜¯ /var/log/kern.log ç­‰åœ°æ–¹æ‰¾åˆ°ä»–ã€‚ä»¥ä¸‹æ˜¯é€™æ¬¡å¯¦éš›é‡åˆ°å•é¡Œæ™‚æ‰€ç”¢ç”Ÿçš„ logï¼Œç”±æ–¼è¨Šæ¯é —é•·ï¼Œæˆ‘æœ‰æŠŠéƒ¨åˆ†å€æ®µçœç•¥ :</p>
<pre tabindex="0"><code>------------[ cut here ]------------
kernel BUG at fs/ext4/inode.c:2292!
Internal error: Oops - BUG: 0 [#1] SMP ARM
Modules linked in: ecryptfs dm_flakey 8021q fuse vhost_scsi(OF) vhost(OF) tcm_loop(OF)  ...
CPU: 0 PID: 24740 Comm: loop1 Tainted: PF O 3.10.108
task: 9f1b4580 ti: 8e0ba000 task.ti: 8e0ba000
PC is at write_cache_pages_da+0x3c0/0x460
LR is at __wait_on_bit_lock+0x80/0xa0
pc : [&lt;801733a4&gt;] lr : [&lt;803f0454&gt;] psr: 00000013
sp : 8e0bbcd8 ip : 00000000 fp : 8e0bbdc0
r10: 00000002 r9 : 00000000 r8 : 000194c3
r7 : 8e0bbe40 r6 : 8df4a788 r5 : 9dc88368 r4 : 8082c1e0
r3 : 0000283d r2 : 9dc8846c r1 : 20000013 r0 : 00000000
Flags: nzcv IRQs on FIQs on Mode SVC_32 ISA ARM Segment kernel
Control: 10c53c7d Table: 1ba0004a DAC: 00000015
Process loop1 (pid: 24740, stack limit = 0x8e0ba238)
Stack: (0x8e0bbcd8 to 0x8e0bc000)
bcc0: 0000000e 805f1510
bce0: 000194c4 00000000 ffffffff 9dc8846c 00000002 0000000e 9edb0f80 7fffff06
bd00: 8e0bbd00 000194d0 0000000e 00000000 80655440 80888300 8082c1e0 808e4b20
...
bfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bfe0: 00000000 00000000 00000000 00000000 00000013 00000000 7423f168 7423eca8
[&lt;801733a4&gt;] (write_cache_pages_da+0x3c0/0x460) from [&lt;80173688&gt;] (ext4_da_writepages+0x244/0x464)
[&lt;80173688&gt;] (ext4_da_writepages+0x244/0x464) from [&lt;800a466c&gt;] (do_writepages+0x30/0x84)
[&lt;800a466c&gt;] (do_writepages+0x30/0x84) from [&lt;8009b350&gt;] (__filemap_fdatawrite_range+0x4c/0x54)
[&lt;8009b350&gt;] (__filemap_fdatawrite_range+0x4c/0x54) from [&lt;8009b474&gt;] (filemap_write_and_wait_range+0x34/0x74)
[&lt;8009b474&gt;] (filemap_write_and_wait_range+0x34/0x74) from [&lt;8016b104&gt;] (ext4_sync_file+0x48/0x29c)
[&lt;8016b104&gt;] (ext4_sync_file+0x48/0x29c) from [&lt;80106aa0&gt;] (vfs_fsync+0x3c/0x54)
[&lt;80106aa0&gt;] (vfs_fsync+0x3c/0x54) from [&lt;7f345c40&gt;] (loop_thread+0x2a8/0x55c [loop])
[&lt;7f345c40&gt;] (loop_thread+0x2a8/0x55c [loop]) from [&lt;8003d9fc&gt;] (kthread+0xb4/0xb8)
[&lt;8003d9fc&gt;] (kthread+0xb4/0xb8) from [&lt;8000e280&gt;] (ret_from_fork+0x14/0x34)
Code: ebfc9a04 e5943000 e3130a02 0affff6d (e7f001f2)
---[ end trace 1e36d7c9ed058ce2 ]---
</code></pre><p>ã€€ã€€æ¯å€‹å¹³å°åœ¨ä¸€äº›å°ç´°ç¯€ä¸Šå¯èƒ½æœƒæœ‰ä¸€é»ä¸ä¸€æ¨£ï¼Œä½†åŸºæœ¬ä¸Šå¤§åŒå°ç•°ã€‚</p>
<p>Â </p>
<h4 id="å‡ºéŒ¯çš„åŸå› ">å‡ºéŒ¯çš„åŸå› </h4>
<p>ã€€ã€€Oops çš„ç¬¬ä¸€è¡Œé€šå¸¸å¯ä»¥å¾—åˆ°éŒ¯èª¤çš„ä¸»è¦åŸå› ï¼Œä¾‹å¦‚é€™æ¬¡æ¡ˆä¾‹æ‰€å°è¨Šæ¯</p>
<pre tabindex="0"><code>kernel BUG at fs/ext4/inode.c:2292!
</code></pre><p>ã€€ã€€é€™å€‹è¨Šæ¯æ˜¯ Kernel BUG_ON é€ æˆçš„ï¼ŒBUG_ON(condition) æ˜¯ä¸€å€‹é¡ä¼¼ assert çš„å‡½å¼ï¼Œcondition é æœŸæ˜¯ä¸æˆç«‹çš„ï¼Œç•¶æˆç«‹çš„æ™‚å€™ï¼Œè¡¨ç¤ºç³»çµ±ç™¼ç”Ÿ BUGï¼Œç„¶å¾Œ kernel å°±æœƒ dump é€™äº›è¨Šæ¯ï¼Œé€šå¸¸æ©Ÿå™¨ä¹Ÿå°±æ›äº†ã€‚</p>
<p>ã€€ã€€BUG_ON é€šå¸¸æœƒæ˜ç¢ºæŒ‡å‡ºéŒ¯èª¤çš„ç¨‹å¼ç¢¼ä½ç½®ï¼Œæ­¤æ™‚å°±å¯ä»¥æ‰“é–‹ç¨‹å¼ç¢¼ç›´æ¥é€²è¡Œå°ç…§ï¼Œåƒé€™æ¬¡ç™¼ç”Ÿå•é¡Œçš„ä½ç½®å°±åœ¨ fs/ext4/inode.c çš„ 2292 è¡Œ</p>
<pre tabindex="0"><code>/*2291*/ wait_on_page_writeback(page);
/*2292*/ BUG_ON(PageWriteback(page));
</code></pre><p>ã€€ã€€é™¤äº† BUG_ON ä»¥å¤–ï¼Œ<code>BUG: unable to handle kernel NULL pointer dereference at (null)</code> ä¹Ÿæ˜¯å¸¸è¦‹çš„éŒ¯èª¤è¨Šæ¯ã€‚</p>
<p>Â </p>
<h4 id="å‡ºéŒ¯çš„ç¨‹åº">å‡ºéŒ¯çš„ç¨‹åº</h4>
<p>ã€€ã€€çŸ¥é“éŒ¯èª¤çš„åŸå› å¾Œï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å¯èƒ½æœƒæƒ³çŸ¥é“æ˜¯å“ªéš» Process è§¸ç™¼äº†é€™å€‹éŒ¯èª¤ :</p>
<pre tabindex="0"><code>CPU: 0 PID: 24740 Comm: loop1 Tainted: PF O 3.10.108
</code></pre><p>ã€€ã€€å¾ä¸Šé¢çš„ log ä¸­ï¼Œæˆ‘å€‘å¯çŸ¥é“ç™¼ç”Ÿå•é¡Œçš„æŒ‡ä»¤(Comm) ç‚º loop1 é€™éš»ç¨‹åºï¼Œå‡ºéŒ¯ç•¶ä¸‹é‹è¡Œåœ¨ CPU 0ï¼Œè€Œ PID ç‚º 24740ã€‚</p>
<p>Â </p>
<h4 id="å‡ºéŒ¯çš„ç¨‹å¼ç¢¼ä½ç½®">å‡ºéŒ¯çš„ç¨‹å¼ç¢¼ä½ç½®</h4>
<p>ã€€ã€€æœ‰äº›æ™‚å€™ï¼Œ dump å‡ºä¾†çš„è¨Šæ¯å¯èƒ½æ²’æœ‰ç›´æ¥æŒ‡å‡ºéŒ¯èª¤çš„ç¨‹å¼ç¢¼ä½ç½®ï¼Œæ­¤æ™‚æˆ‘å€‘éœ€è¦å€ŸåŠ©å…¶ä»–è³‡è¨Šä¾†è¿½è¹¤ï¼Œå¯ä»¥åˆ©ç”¨çš„å°±æ˜¯ PC (Program Counter) ä¸­æ‰€è¨˜éŒ„çš„è³‡è¨Šï¼Œä¾‹å¦‚ä»¥ä¸‹ log</p>
<pre tabindex="0"><code>PC is at write_cache_pages_da+0x3c0/0x460
</code></pre><p>ã€€ã€€PC (Program Counter) æ˜¯ç¨‹å¼è¨ˆæ•¸å™¨ï¼Œå„²å­˜çš„æ˜¯ç›®å‰é›»è…¦åŸ·è¡Œçš„æŒ‡ä»¤ä½å€ã€‚Oops ç™¼ç”Ÿæ™‚ï¼Œkernel æœƒæŠŠç™¼ç”Ÿç•¶ä¸‹çš„æš«å­˜å™¨ç‹€æ…‹ä¿ç•™ä¸‹ä¾†ï¼Œè€Œä¿å­˜ä¸‹ä¾†çš„ PC å°±æ˜¯å‡ºéŒ¯æ™‚çš„åŸ·è¡Œä½å€å›‰ï¼åœ¨ x86 çš„ç³»çµ±ä¸Šï¼Œä»–é€šå¸¸æœƒå« IP (Instruction Pointer)ï¼Œä½†æ„æ€æ˜¯é¡ä¼¼çš„ã€‚</p>
<p>ã€€ã€€ç¾åœ¨æˆ‘å€‘çŸ¥é“å‡ºå•é¡Œçš„ä½ç½®æ˜¯ write_cache_pages_da+0x3c0ï¼Œä»£è¡¨ write_cache_pages_da å‡½å¼ä¸­ offset ç‚º 0x3c0 çš„åœ°æ–¹ï¼Œä½†å¦‚ä½•å¾—çŸ¥ offset 0x3c0 å¯¦éš›æŒ‡çš„æ˜¯ç¨‹å¼çš„å“ªä¸€è¡Œå‘¢ï¼Ÿ</p>
<p>ã€€ã€€æˆ‘å€‘å¯ä»¥å€ŸåŠ© gdb ä¾†è®€å‡º binary å…§çš„é™¤éŒ¯è¨Šæ¯ã€‚ç”¨ gdb è®€å…¥ä½ çš„ vmlinux æˆ–æ˜¯å‡½å¼æ‰€åœ¨çš„ kernel module å¾Œï¼Œè¼¸å…¥ <code>list*(write_cache_pages_da+0x3c0)</code>ï¼Œå°±å¯ä»¥æ‰¾åˆ°éŒ¯èª¤çš„ä½ç½®äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0f0"># gdb ext4.ko</span>
</span></span><span style="display:flex;"><span>(gdb) list *(write_cache_pages_da+0x3c0)
</span></span><span style="display:flex;"><span>0x53e8 is in write_cache_pages_da (fs/ext4/inode.c:2292).
</span></span><span style="display:flex;"><span>2289	}
</span></span><span style="display:flex;"><span><span style="color:#f60">2290</span>
</span></span><span style="display:flex;"><span>2291	wait_on_page_writeback(page);
</span></span><span style="display:flex;"><span>2292	BUG_ON(PageWriteback(page));
</span></span><span style="display:flex;"><span><span style="color:#f60">2293</span>
</span></span><span style="display:flex;"><span>2294	/*</span></span></code></pre></div>
<p>ã€€ã€€æœ‰æ™‚å€™ä½ç½®å¯èƒ½æœƒèª¤å·®ä¸€åˆ°å…©è¡Œï¼Œä½†é€šå¸¸ä¹Ÿå·²ç¶“è¶³å¤ ç²¾ç¢ºè®“æˆ‘å€‘é€²è¡Œåˆ¤æ–·ï¼Œå¦å¤–è¦æ³¨æ„ï¼Œå¦‚æœä½ çš„ kernel æ²’æœ‰æ‰“é–‹ CONFIG_DEBUG_INFO çš„é¸é …ï¼Œä½ å¯èƒ½æœƒéœ€è¦æ‰“é–‹ä»–ä¸¦é‡æ–°å»ºç½®ï¼Œå¦å‰‡ gdb æœƒæ‰¾ä¸åˆ° debug symbolã€‚</p>
<p>Â </p>
<h4 id="å‡ºéŒ¯çš„éç¨‹-call-stack">å‡ºéŒ¯çš„éç¨‹ (Call Stack)</h4>
<p>ã€€ã€€æ¥ä¸‹ä¾†æˆ‘å€‘å¯èƒ½æœƒæƒ³çŸ¥é“å‡ºéŒ¯çš„ç¨‹å¼æ˜¯å¾å“ªäº›å‡½å¼ä¸€å±¤ä¸€å±¤å‘¼å«é€²ä¾†ï¼Œæˆ‘å€‘å¯ä»¥å¾ Oops æ‰€å°çš„ Call Stack çš„è¨Šæ¯ä¾†å¾—çŸ¥:</p>
<pre tabindex="0"><code>[&lt;801733a4&gt;] (write_cache_pages_da+0x3c0/0x460) from [&lt;80173688&gt;] (ext4_da_writepages+0x244/0x464)
[&lt;80173688&gt;] (ext4_da_writepages+0x244/0x464) from [&lt;800a466c&gt;] (do_writepages+0x30/0x84)
[&lt;800a466c&gt;] (do_writepages+0x30/0x84) from [&lt;8009b350&gt;] (__filemap_fdatawrite_range+0x4c/0x54)
[&lt;8009b350&gt;] (__filemap_fdatawrite_range+0x4c/0x54) from [&lt;8009b474&gt;] (filemap_write_and_wait_range+0x34/0x74)
[&lt;8009b474&gt;] (filemap_write_and_wait_range+0x34/0x74) from [&lt;8016b104&gt;] (ext4_sync_file+0x48/0x29c)
[&lt;8016b104&gt;] (ext4_sync_file+0x48/0x29c) from [&lt;80106aa0&gt;] (vfs_fsync+0x3c/0x54)
[&lt;80106aa0&gt;] (vfs_fsync+0x3c/0x54) from [&lt;7f345c40&gt;] (loop_thread+0x2a8/0x55c [loop])
[&lt;7f345c40&gt;] (loop_thread+0x2a8/0x55c [loop]) from [&lt;8003d9fc&gt;] (kthread+0xb4/0xb8)
[&lt;8003d9fc&gt;] (kthread+0xb4/0xb8) from [&lt;8000e280&gt;] (ret_from_fork+0x14/0x34)
</code></pre><p>ã€€ã€€ä¾‹å¦‚ä»¥ä¸Šçš„ logï¼Œå‡ºéŒ¯æ™‚çš„å‘¼å«éç¨‹æ˜¯ <code>kthread -&gt; loop_thread -&gt; vfs_fsync -&gt; ext4_sync_file -&gt; ... -&gt; write_cache_pages_da</code> é€™æ¨£ä¸€å±¤ä¸€å±¤å‘¼å«èµ°åˆ°å‡ºéŒ¯ç•¶ä¸‹çš„ç¨‹å¼ç¢¼ã€‚å¦‚æœæœ‰éœ€æ±‚çš„è©±ï¼Œåƒæ˜¯ ext4_sync_file+0x48 ä¹‹é¡çš„è¨Šæ¯ï¼Œæˆ‘å€‘ä¹Ÿä¸€æ¨£å¯ä»¥åˆ©ç”¨ gdb æ‰¾å‡ºå¯¦éš›åœ¨ç¨‹å¼ç¢¼çš„å“ªä¸€è¡Œã€‚</p>
<p>Â </p>
<h4 id="å‡ºéŒ¯çš„è¨˜æ†¶é«”è³‡è¨Š">å‡ºéŒ¯çš„è¨˜æ†¶é«”è³‡è¨Š</h4>
<p>ã€€ã€€æœ‰äº›æ™‚å€™æˆ‘å€‘é‚„éœ€è¦è¨˜æ†¶é«”ç›¸é—œçš„è³‡è¨Šä¾†å”åŠ©æˆ‘å€‘åˆ¤æ–·å•é¡Œï¼Œä¾‹å¦‚é€™æ¬¡çš„æ¡ˆä¾‹ä¸­ï¼ŒBUG æ˜¯ç™¼ç”Ÿåœ¨ page-&gt;flags æœ‰ 0x2000 (PG_writeback) é€™å€‹ bit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>wait_on_page_writeback(page);  <span style="color:#0f0">// è‹¥ page-&gt;flags æœ‰ PG_writebackï¼Œå°±ç­‰åˆ°ä»–è¢«æ¸…é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>BUG_ON(PageWriteback(page));   <span style="color:#0f0">// è‹¥ page-&gt;flags çš„ PG_writeback é‚„åœ¨ï¼Œå°±è§¸ç™¼ BUG
</span></span></span></code></pre></div>
<p>ã€€ã€€page-&gt;flags é€™å€‹è®Šæ•¸ç•¶æ™‚åˆ°åº•æ˜¯ä»€éº¼å€¼å‘¢ï¼Ÿæˆ‘å€‘æ­¤æ™‚éœ€è¦ dump å‡ºä¾†çš„æš«å­˜å™¨ä¾†å”åŠ©æˆ‘å€‘æ‰¾å‡ºç•¶ä¸‹çš„è®Šæ•¸å€¼ã€‚</p>
<p>ã€€ã€€ç”±æ–¼ Oops ä¸¦æ²’æœ‰å‘Šè¨´æˆ‘å€‘å„å€‹æš«å­˜å™¨ç•¶æ™‚æ˜¯åœ¨è™•ç†ä»€éº¼è®Šæ•¸ï¼Œå› æ­¤æœƒéœ€è¦å°ç…§ç·¨è­¯å¾Œçš„çµ„åˆèªè¨€ä¾†é€²è¡Œç¢ºèªï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨ objdump -d ä¾†è§£å‡ºäººæ¯”è¼ƒå¥½çœ‹æ‡‚çš„çµ„åˆèªè¨€ã€‚ä»¥ä¸‹æ˜¯é€™æ¬¡æ¡ˆä¾‹çš„ objdump çµæœ:</p>
<pre tabindex="0"><code># objdump -d ext4.ko
...
00005028 &lt;write_cache_pages_da&gt;:
...
53d8: ebfffffe bl  0 &lt;wait_on_page_bit&gt;
53dc: e5943000 ldr r3, [r4]    ; æŠŠ [r4] è®€åˆ° r3
53e0: e3130a02 tst r3, #8192   ; æ¸¬è©¦ r3 çš„ 0x2000 (PG_writeback) bit æ˜¯å¦ç‚ºé›¶
53e4: 0affff6d beq 51a0 &lt;write_cache_pages_da+0x178&gt;  ; jump
53e8:	e7f001f2 	.word	0xe7f001f2
...
</code></pre><p>ã€€ã€€ç”±æ–¼ dump å‡ºä¾†å…§å®¹å¾ˆé•·ï¼Œæ‰€ä»¥æˆ‘åªç•™ä¸‹äº†é—œéµçš„éƒ¨åˆ†ã€‚è‡³æ–¼è¦å¦‚ä½•æ‰¾åˆ°é—œéµçš„çµ„èªä½ç½®å‘¢ï¼Ÿæˆ‘å€‘çŸ¥é“å‡ºéŒ¯çš„åœ°æ–¹æ˜¯ write_cache_pages_da+0x3c0ï¼Œå¯ä»¥ç›´æ¥åœ¨ objdump æœå°‹ &lt;write_cache_pages_da&gt;ï¼Œå‰æ–¹æœ‰è©²å‡½å¼çš„ä½å€ï¼Œåƒé€™æ¬¡çš„ä½å€æ˜¯ 0x5028ï¼Œä¹‹å¾Œå†åŠ ä¸Š 0x3c0 æˆ‘å€‘å¯ä»¥å¾—åˆ° 0x53e8ï¼Œè€Œé—œéµçš„çµ„èªå¯èƒ½å°±æœƒåœ¨é€™å€‹ä½å€çš„é™„è¿‘ã€‚</p>
<p>ã€€ã€€å¾çµ„åˆèªè¨€ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå‡ºéŒ¯çš„ç•¶ä¸‹æ˜¯æŠŠ r4 çš„ä½å€è®€åˆ° r3ï¼Œä¸¦æª¢æŸ¥ r3 æ˜¯å¦æœ‰ 0x2000 çš„ bitã€‚ä¹Ÿå°±æ˜¯ page-&gt;flags é€™å€‹è®Šæ•¸è¢«æ”¾å…¥äº† r3 æš«å­˜å™¨ï¼Œè€Œ r4 çš„æš«å­˜å™¨å‰‡æ˜¯å­˜è‘— page-&gt;flags çš„è¨˜æ†¶é«”ä½å€ï¼Œå†å°ç…§å…ˆå‰çš„ dump è³‡è¨Šï¼Œæˆ‘å€‘å¯ä»¥ç™¼ç¾å‡ºéŒ¯ç•¶ä¸‹çš„ r3 ç‚º 0000283dï¼Œç¢ºå¯¦æœ‰ 0x2000 çš„ bitï¼</p>
<pre tabindex="0"><code>sp : 8e0bbcd8 ip : 00000000 fp : 8e0bbdc0
r10: 00000002 r9 : 00000000 r8 : 000194c3
r7 : 8e0bbe40 r6 : 8df4a788 r5 : 9dc88368 r4 : 8082c1e0
r3 : 0000283d r2 : 9dc8846c r1 : 20000013 r0 : 00000000
</code></pre><p>ã€€ã€€ç”±æ–¼ 0x283d æ˜¯ä¸€å€‹åˆç†çš„ page flagsï¼Œæ‰€ä»¥åœ¨é€™å€‹ä¾‹å­ä¸­ï¼Œæˆ‘å€‘å¯ä»¥æš«ä¸”æ’é™¤è¨˜æ†¶é«”æº¢ä½ä¹‹é¡çš„å› ç´ ï¼Œå°è‡´ page-&gt;flags è¢«åˆ¥äººå¯«å£çš„å¯èƒ½æ€§ï¼Œå› ç‚ºè¦æº¢ä½ä¸”å¯«å…¥åˆç†çš„è®Šæ•¸å€¼ï¼Œé‚£é›£åº¦ä¹Ÿå¤ªé«˜äº†ã€‚</p>
<p>Â </p>
<h3 id="æ·±å…¥è¿½è¹¤å•é¡Œ">æ·±å…¥è¿½è¹¤å•é¡Œ</h3>
<p>ã€€ã€€è‡³æ­¤æˆ‘å€‘å·²ç¶“å°å‡ºéŒ¯æ™‚çš„ç³»çµ±ç‹€æ³æœ‰äº†åˆæ­¥çš„è¼ªå»“ï¼Œæ¯”è¼ƒç°¡å–®çš„å•é¡Œå¯èƒ½å¾ä»¥ä¸Šçš„è³‡è¨Šå°±å¯ä»¥æ‰¾åˆ°ä¿®å¾©çš„è¾¦æ³•ã€‚</p>
<p>ã€€ã€€è¨±å¤šè¤‡é›œå•é¡Œé‚„éœ€è¦ç¨‹å¼æ·±å…¥çš„ç†è§£æ‰èƒ½æ‰¾å‡º root causeï¼Œé€™æ™‚å€™åªèƒ½æ…¢æ…¢æª¢æŸ¥ç¨‹å¼ç¢¼æˆ–æ˜¯æ‰¾å‡ºå…¶ä»–é‡è£½æ­¥é©Ÿç­‰ç­‰ã€‚åœ¨é€™å€‹æ¡ˆä¾‹ä¸­ï¼Œæˆ‘å€‘å¾ŒçºŒé‚„å¯¦éš›æ¸¬è©¦è­‰æ˜ç¨‹å¼é‚è¼¯ï¼Œæ’é™¤äº† lock å¿˜è¨˜æ‹¿ç­‰ç­‰å¯èƒ½ï¼Œæ‰é€æ­¥è¿½è¹¤å‡ºçœŸæ­£çš„éŒ¯èª¤åŸå› ã€‚</p>

      <div class="share-icons d-flex justify-content-center d-print-none">
        <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.jaycetyle.com%2f2019%2f12%2flinux-bug-on-case-study%2f&text=Linux%20Kernel%20BUG_ON%20%e5%82%be%e5%8d%b0%e8%a8%8a%e6%81%af%e5%88%86%e6%9e%90%e5%8f%8a%e6%a1%88%e4%be%8b%e5%88%86%e4%ba%ab&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.jaycetyle.com%2f2019%2f12%2flinux-bug-on-case-study%2f&t=Linux%20Kernel%20BUG_ON%20%e5%82%be%e5%8d%b0%e8%a8%8a%e6%81%af%e5%88%86%e6%9e%90%e5%8f%8a%e6%a1%88%e4%be%8b%e5%88%86%e4%ba%ab" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.jaycetyle.com%2f2019%2f12%2flinux-bug-on-case-study%2f&title=Linux%20Kernel%20BUG_ON%20%e5%82%be%e5%8d%b0%e8%a8%8a%e6%81%af%e5%88%86%e6%9e%90%e5%8f%8a%e6%a1%88%e4%be%8b%e5%88%86%e4%ba%ab&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
      </div>
    </div>

    

    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jaycetyle" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  <div class="sidebar d-print-none d-none d-xl-block">
  <h5 class="mt-4 post-title">Recent Posts</h5>
  <ul class="mt-2 pl-4">
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2021/10/linux-fio-tips/">Linux fio æ¸¬è©¦åƒæ•¸çš„çœ‰çœ‰è§’è§’</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2021/10/kprobe-userspace-tool/">Kprobe Userspace Tool ä½¿ç”¨ç­†è¨˜</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2019/12/linux-bug-on-case-study/">Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2019/11/passing-smart-pointer/">[C&#43;&#43;] å¹¾ç¨®åœ¨å‡½æ•¸å‚³é Smart Pointer çš„æ–¹å¼æ•´ç†</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2019/10/jekyll-to-hugo/">å¾ Jekyll é·ç§»åˆ° Hugo æ­¥é©Ÿå¿ƒå¾—åˆ†äº«</a></li>
    
  </ul>
  <h5 class="mt-4 text-capitalize post-title">Tags</h5>
  <ul class="mt-2 pl-4">
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/c/c&#43;&#43;/'>
      C/C&#43;&#43;
      <span class="badge badge-pill badge-secondary">11</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/ubuntu-%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/'>
      Ubuntu ä½œæ¥­ç³»çµ±
      <span class="badge badge-pill badge-secondary">7</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/linux-kernel/'>
      Linux Kernel
      <span class="badge badge-pill badge-secondary">6</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/'>
      é–‹ç™¼ç’°å¢ƒ
      <span class="badge badge-pill badge-secondary">5</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/'>
      ç‰ˆæœ¬æ§åˆ¶
      <span class="badge badge-pill badge-secondary">4</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E9%96%92%E8%81%8A/'>
      é–’èŠ
      <span class="badge badge-pill badge-secondary">4</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E6%A8%B9%E8%8E%93%E6%B4%BE/'>
      æ¨¹è“æ´¾
      <span class="badge badge-pill badge-secondary">3</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E7%B6%B2%E7%AB%99%E6%9E%B6%E8%A8%AD/'>
      ç¶²ç«™æ¶è¨­
      <span class="badge badge-pill badge-secondary">3</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/c%23/'>
      C#
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/linux-system-performance/'>
      Linux System Performance
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/nas-%E8%88%87%E8%B3%87%E6%96%99%E5%82%99%E4%BB%BD/'>
      NAS èˆ‡è³‡æ–™å‚™ä»½
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/python/'>
      Python
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E5%B7%A5%E5%85%B7%E8%BB%9F%E9%AB%94/'>
      å·¥å…·è»Ÿé«”
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
  </ul>
</div>

        </div>

        <footer class="mt-auto footer d-print-none">
            <div class="container-fluid">
                <div class="d-flex col-xl-12 justify-content-center">
                    <div>Â© 2019<a href="https://blog.jaycetyle.com/about/"> Lin Chieh ( Jayce )</a>. Powered by <a href="https://gohugo.io/">Hugo</a> using <a href='https://www.mattbutton.com'>Matt Button</a>'s <a href='https://github.com/mattbutton/silhouette-hugo'>Silhouette Hugo</a> theme.</div>
                </div>
                </hr>
                <div class="d-flex justify-content-center icons">
                    <a class="py-2 px-2" href="https://www.linkedin.com/in/chieh-lin-569430a9/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href="https://github.com/jaycetyle/"><i class="fab fa-github"></i></a>
<a class="py-2 px-2" href='https://blog.jaycetyle.com/index.xml'><i class="fas fa-rss"></i></a>

                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-1ZFSFPEZG5"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-1ZFSFPEZG5');
        }
      </script>
    </body>
</html>
