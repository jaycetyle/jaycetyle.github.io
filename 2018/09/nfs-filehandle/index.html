<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <meta property="og:url" content="https://blog.jaycetyle.com/2018/09/nfs-filehandle/">
  <meta property="og:site_name" content="Jayce çš„å…±äº«è¨˜æ†¶é«”">
  <meta property="og:title" content="Linux NFS filehandle ç­†è¨˜">
  <meta property="og:description" content="æœ€è¿‘å› ç‚ºåœ¨çœ‹ Linux NFS ç›¸é—œçš„ç¨‹å¼ç¢¼ï¼Œè¶é‚„æœ‰é»è¨˜æ†¶çš„æ™‚å€™ä¾†ç­†è¨˜ä¸€ä¸‹ï¼Œé€™ç¯‡ä¸»è¦ç­†è¨˜ NFS filehandleï¼Œæ˜¯ NFS æ“ä½œé ç«¯æª”æ¡ˆç³»çµ±çš„æœ€åŸºç¤æ©Ÿåˆ¶ä¹‹ä¸€ï¼Œç”¨ä¾†è¡¨ç¤ºä¸€å€‹æ–‡ä»¶ã€‚">
  <meta property="og:locale" content="zh_tw">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2018-09-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-02T00:00:00+00:00">
    <meta property="article:tag" content="Linux Kernel">

        
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Linux NFS filehandle ç­†è¨˜">
  <meta name="twitter:description" content="æœ€è¿‘å› ç‚ºåœ¨çœ‹ Linux NFS ç›¸é—œçš„ç¨‹å¼ç¢¼ï¼Œè¶é‚„æœ‰é»è¨˜æ†¶çš„æ™‚å€™ä¾†ç­†è¨˜ä¸€ä¸‹ï¼Œé€™ç¯‡ä¸»è¦ç­†è¨˜ NFS filehandleï¼Œæ˜¯ NFS æ“ä½œé ç«¯æª”æ¡ˆç³»çµ±çš„æœ€åŸºç¤æ©Ÿåˆ¶ä¹‹ä¸€ï¼Œç”¨ä¾†è¡¨ç¤ºä¸€å€‹æ–‡ä»¶ã€‚">


        <title>
  Linux NFS filehandle ç­†è¨˜ | Jayce çš„å…±äº«è¨˜æ†¶é«”
</title>

        

<link rel="shortcut icon" href="/images/favicon.ico">

<link rel="shortcut icon" href="/images/favicon.png">

<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">


        <link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">      
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

        
        
        
        
        
        <link rel="stylesheet" href="https://blog.jaycetyle.com/css/styles.min.6a7e3e1c24ad4b4b16f344cfc54f4b5a4e92f35366ada3879f0176264c5f99b9.css" integrity="sha256-an4&#43;HCStS0sW80TPxU9LWk6S81NmraOHnwF2Jkxfmbk=">
        
        
        <link id="theme-style" rel="stylesheet" href="">

        
        <script>
            window.themeUrls = {
            light: "\/css\/light.min.0d91bc92b83a6a8aac989d53ce618ea99f98702fd931a07d8219dd7c3ae030eb.css",
            dark: "\/css\/dark.min.af88a93f842d8c67b00708066264a518670df2f2fc97f2246b1282d6c721961c.css"
            };
        </script>
        
  <link rel="me" type="text/html" href="https://www.linkedin.com/in/chieh-lin-569430a9/"/>


<link rel="shortcut icon" href="/images/favicon.ico">

<link rel="shortcut icon" href="/images/favicon.png">

<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">


<link rel="alternate" type="application/rss+xml" href='https://blog.jaycetyle.com/index.xml' />

<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="author" content="" />
<meta name="copyright" content="" />


<meta name="description" content="æœ€è¿‘å› ç‚ºåœ¨çœ‹ Linux NFS ç›¸é—œçš„ç¨‹å¼ç¢¼ï¼Œè¶é‚„æœ‰é»è¨˜æ†¶çš„æ™‚å€™ä¾†ç­†è¨˜ä¸€ä¸‹ï¼Œé€™ç¯‡ä¸»è¦ç­†è¨˜ NFS filehandleï¼Œæ˜¯ NFS æ“ä½œé ç«¯æª”æ¡ˆç³»çµ±çš„æœ€åŸºç¤æ©Ÿåˆ¶ä¹‹ä¸€ï¼Œç”¨ä¾†è¡¨ç¤ºä¸€å€‹æ–‡ä»¶ã€‚">

  <style type="text/css">
  .feature-image {
    background-image: linear-gradient(
      rgba(0, 0, 0, 0.15),
      rgba(0, 0, 0, 0.15)
    ), url('https://blog.jaycetyle.com/images/banner.jpg');
    height: 400px;
    background-repeat:no-repeat;
    background-size:cover;
    background-position: center;
  }
  .feature-image-text {
    margin-top: 20px;
  }

  @media (max-width: 1024px) {
    .feature-image {
      height: 300px;
    }
  }

  @media (max-width: 768px) {
    .feature-image {
      height: 250px;
    }
  }

  @media (max-width: 520px) {
    .feature-image {
      display: none;
    }
  }
</style>




    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-md navbar-primary bg-primary py-1 top-nav">
            <div class="container">
                    <a href="https://blog.jaycetyle.com/"><img class="logo" src="https://blog.jaycetyle.com//images/logo.png"></a>
<a class="navbar-brand pr-4 d-none d-sm-block" href="https://blog.jaycetyle.com/">Jayce&#39;s Shared Memory</a>
                <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars" style="color:black"></i>
                </button>
                <div class="navbar-collapse collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/">Home</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/archive/">Archive</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://github.com/jaycetyle">Github</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://blog.jaycetyle.com/about/">About</a>
</li>
<li class="nav-item">
    <button id="theme-toggle" class="nav-link" style="background: transparent; border: none; color: inherit; cursor: pointer;">
        ğŸŒ™
    </button>
</li>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const themeLink = document.getElementById("theme-style");
        const toggleBtn = document.getElementById("theme-toggle");

        function getPreferredTheme() {
            return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }

        function setTheme(theme) {
            themeLink.href = window.themeUrls[theme];
            toggleBtn.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
            iframe.contentWindow.postMessage({
                giscus: {
                setConfig: {
                    theme: theme
                }
                }
            }, 'https://giscus.app');
            }
        }

        let currentTheme = getPreferredTheme();
        setTheme(currentTheme);

        toggleBtn.addEventListener("click", function () {
            currentTheme = currentTheme === "dark" ? "light" : "dark";
            setTheme(currentTheme);
        });
    });
</script>
                    </ul>
                </div>
            </div>
        </nav>

        
  <header class="feature-image">
  <div class="feature-image-text white-shadow-text">
    <h1 class="font-weight:bold">Linux NFS filehandle ç­†è¨˜</h1>
  </div>
</header>


        <div class="container main my-4">
            
  <div class="post p-3 p-sm-5">
    <h3 class="post-title">Linux NFS filehandle ç­†è¨˜</h3>
    <div class="mt-2 mb-3">
    <small>
        <strong>By Lin Chieh (Jayce)</strong>
        | <i class="far fa-calendar-alt"></i>&nbsp;Sep 8, 2018&nbsp;
        | <i class="fa fa-tags" title="Tags" aria-hidden="true"></i> <a href='/tags/linux-kernel/'>Linux Kernel</a>
    </small>
</div>

    <div class="mt-4 mb-4 main-content">
      <p>ã€€ã€€æœ€è¿‘åœ¨çœ‹ Linux NFS ç›¸é—œçš„ç¨‹å¼ç¢¼ï¼Œè¶é‚„æœ‰é»è¨˜æ†¶çš„æ™‚å€™ä¾†ç­†è¨˜ä¸€ä¸‹ï¼Œé€™ç¯‡ä¸»è¦ç­†è¨˜ NFS filehandle çš„é‹ä½œæ©Ÿåˆ¶ã€‚</p>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<p>ã€€ã€€filehandle æ˜¯ NFS æ“ä½œé ç«¯æª”æ¡ˆç³»çµ±çš„æœ€åŸºç¤æ©Ÿåˆ¶ä¹‹ä¸€ï¼Œç”¨ä¾†è¡¨ç¤ºä¸€å€‹å°æ‡‰çš„æ–‡ä»¶ï¼Œå¾ C èªè¨€çš„è§’åº¦ä¾†çœ‹ï¼Œä»–å¾ˆé¡ä¼¼ fopen æ‰€å¾—åˆ°çš„ file descriptorï¼Œå°æ–¼ä½¿ç”¨è€…è€Œè¨€ï¼Œfilehandle/file descriptor æ˜¯ä¸€ç¨®ä¸é€æ˜(opaque)çš„è³‡æ–™çµæ§‹ï¼Œä½¿ç”¨è€…ä¸éœ€è¦çŸ¥é“ä»–å¯¦éš›ä¸Šå­˜äº†äº›ä»€éº¼ï¼Œåªè¦çŸ¥é“æœ‰ä»–å°±å¯ä»¥æ“ä½œåˆ°å°æ‡‰çš„æª”æ¡ˆã€‚</p>
<p>ã€€ã€€ç›¸è¼ƒæ–¼ç›´æ¥ä½¿ç”¨æª”æ¡ˆè·¯å¾‘ä¾†è¡¨ç¤ºä¸€å€‹æª”æ¡ˆï¼Œä½¿ç”¨ filehandle æœ‰å…©å€‹ä¸»è¦çš„å„ªé»åŠç›®çš„ï¼Œé¦–å…ˆï¼Œfilehandle é€šå¸¸æ˜¯ä¸€å€‹è¼ƒå°ä¸”è¼ƒç‚ºå›ºå®šçš„å¤§å°ï¼Œå°ç¶²è·¯å‚³è¼¸æœ‰å…¶ä¾¿åˆ©æ€§ï¼Œå…¶æ¬¡æ˜¯ä»–ç¸½æ˜¯ä»£è¡¨ç›¸åŒçš„æª”æ¡ˆï¼Œå°±ç®—å°è±¡æª”æ¡ˆè¢«é‡æ–°å‘½åæˆ–æ˜¯è¢«ç§»å‹•éï¼Œä»–é‚„æ˜¯èƒ½æ‰¾å›åŸæœ¬çš„é‚£å€‹æª”æ¡ˆã€‚</p>
<h3 id="filehandle-çµæ§‹">filehandle çµæ§‹</h3>
<p>ã€€ã€€filehandle ä¸»è¦åŒ…å«äº†å…©å€‹ä¸»è¦æˆä»½ï¼Œåˆ†åˆ¥æ˜¯ä»£è¡¨åŒ¯å‡ºè·¯å¾‘(export point)æª”æ¡ˆç³»çµ±çš„ fsidï¼Œä»¥åŠä»£è¡¨æª”æ¡ˆç³»çµ±å…§ä¸€å€‹æª”æ¡ˆçš„ fileidï¼Œæˆ‘å€‘å¯ä»¥çœ‹ Linux æ ¸å¿ƒå…§æ˜¯å¦‚ä½•å®šç¾©ä»–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00">struct</span> nfs_fhbase_new {
</span></span><span style="display:flex;"><span>	__u8		fb_version;	<span style="color:#0f0">/* ä»£è¡¨ç‰ˆæœ¬ï¼Œç›®å‰å›ºå®šç‚º 1, even =&gt; nfs_fhbase_old */</span>
</span></span><span style="display:flex;"><span>	__u8		fb_auth_type;	<span style="color:#0f0">/* deprecated æ²’æœ‰è¢«ä½¿ç”¨ */</span>
</span></span><span style="display:flex;"><span>	__u8		fb_fsid_type;
</span></span><span style="display:flex;"><span>	__u8		fb_fileid_type;
</span></span><span style="display:flex;"><span>	__u32		fb_auth[<span style="color:#f60">1</span>];	<span style="color:#0f0">/* deprecated æ²’æœ‰è¢«ä½¿ç”¨ */</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0">/*	__u32		fb_fsid[0]; floating */</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0">/*	__u32		fb_fileid[0]; floating */</span>
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div>
<p>ã€€ã€€fb_auth_type åŠ fb_auth å·²ç¶“æ˜¯ deprecated æ²’æœ‰è¢«ä½¿ç”¨ï¼Œå› æ­¤ä¸»è¦çš„éƒ¨ä»½å°±åªå‰©ä¸‹ fsid åŠ fileidã€‚</p>
<h3 id="fsid">fsid</h3>
<p>ã€€ã€€fb_fsid_type ç”¨ä¾†è¡¨ç¤ºå¾Œé¢çš„ fb_fsid å¦‚ä½•è¡¨ç¤ºä¸€å€‹åŒ¯å‡ºçš„æª”æ¡ˆç³»çµ±ï¼Œé€™å…©å€‹å€¼æˆ‘æ²’å®Œå…¨ææ‡‚ä»–åˆ°åº•æ˜¯å¦‚ä½•åœ¨ user space å’Œ kernel space ä¹‹é–“å‚³éï¼Œä¹‹å¾Œè¦æ‰¾æ™‚é–“å†æ·±å…¥çœ‹ä¸€ä¸‹ï¼Œä½†å°±æˆ‘ç›®å‰èªçŸ¥çš„æ˜¯ï¼Œä»–æ˜¯ç”± nfs-utils å…§çš„ <strong>mountd</strong> ä¾†åšåˆå§‹è¨­å®šã€‚</p>
<p>ã€€ã€€å‰›é–‹å§‹æˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ç‚ºä½•æ˜¯ mountdï¼Œä½†ä»”ç´°æ€è€ƒäº†ä¸€ä¸‹ï¼Œçµ¦æŒç®¡åŒ¯å‡ºè·¯å¾‘çš„ mountd ä¾†æŒ‡å®š fsid ä¹Ÿæ˜¯åˆç†çš„ã€‚ä¹Ÿè¨±æœƒå•ï¼Œå¹³å¸¸æ›´æ–° /etc/exports æ™‚éƒ½æ˜¯é€é exportfs ä¾†é‡æ–°è¼‰å…¥ï¼Œé›£é“ä¸æ˜¯ exportfs åœ¨ç®¡ç†åŒ¯å‡ºå—ï¼Ÿä½†å¯¦éš›ä¸Š exportfs æ¯”è¼ƒåƒæ˜¯ mountd çš„è¼”åŠ©ç¨‹å¼ï¼ŒçœŸæ­£å’Œæ ¸å¿ƒæºé€šçš„é‚„æ˜¯ mountdã€‚</p>
<p>ã€€ã€€mountd åœ¨æ±ºå®š fsid æ™‚å¤§è‡´ä¸Šæœ‰äºŒç¨®æ–¹å¼ï¼Œç¬¬ä¸€ç¨®æ˜¯ä½¿ç”¨è€…åœ¨ /etc/exports å…§ç›´æ¥æŒ‡å®š fsid=NUMï¼Œç¬¬äºŒç¨®æ˜¯ä½¿ç”¨ UUIDï¼Œè€Œ UUID åˆæœ‰å…©ç¨®å–å¾—æ–¹å¼ï¼Œç¬¬ä¸€ç¨®ï¼Œä¹Ÿæ˜¯å„ªå…ˆé¸æ“‡çš„æ˜¯æª”æ¡ˆç³»çµ±æ›è¼‰çš„ blkidï¼Œç¬¬äºŒç¨®æ˜¯é€é statfs å–å¾— filesystem çš„ UUIDã€‚</p>
<p>ã€€ã€€ä¸åŒçš„ filesystem é©ç”¨æ–¼ä¸åŒçš„ UUID å–å¾—æ–¹å¼ï¼Œä¾‹å¦‚ FAT é€é statfs å¾—åˆ°çš„ fsid æ˜¯ device numberï¼Œä½† device number æ˜¯å¯èƒ½æœƒæ”¹è®Šçš„ï¼Œå› æ­¤ä¸¦ä¸æ°ç•¶ã€‚ç›¸åçš„ä¾‹å­æ˜¯ btrfs çš„ subvolumeï¼Œæ¯å€‹ subvolume æœ‰ä¸åŒçš„ fsidï¼Œä½†å…±ç”¨åŒä¸€å€‹ blkidï¼Œbtrfs ä½¿ç”¨ fsid æœƒæœ‰ä»–çš„æ„ç¾©ã€‚</p>
<p>ã€€ã€€ç›¸é—œçš„ç¨‹å¼ç¢¼ä½æ–¼ <a href="http://git.linux-nfs.org/?p=steved/nfs-utils.git;a=blob;f=utils/mountd/cache.c">nfs-utils/utils/mountd/cache.c</a> å…§çš„ uuid_by_path å‡½å¼ã€‚</p>
<h3 id="fileid">fileid</h3>
<p>ã€€ã€€fileid çš„ç·¨ç¢¼(encode) å‰‡æ˜¯ç”±æ¯å€‹æª”æ¡ˆç³»çµ±è‡ªè¡Œå¯¦ä½œï¼Œé€™ä¹Ÿæ˜¯ä¸€å€‹æª”æ¡ˆç³»çµ±è¦æ”¯æ´ NFS æœ€åŸºæœ¬éœ€è¦å¯¦ä½œçš„éƒ¨ä»½ï¼Œç›¸é—œçš„å‡½å¼ä»‹é¢å®šç¾©åœ¨ä»¥ä¸‹çµæ§‹ï¼Œæœ€æ ¸å¿ƒçš„å‡½æ•¸ç‚º encode_fhã€fh_to_dentryã€fh_to_parent åŠ get_parentï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00">struct</span> export_operations {
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*encode_fh)(<span style="color:#f00">struct</span> inode *inode, __u32 *fh, <span style="color:#ee82ee">int</span> *max_len,
</span></span><span style="display:flex;"><span>			<span style="color:#f00">struct</span> inode *parent);
</span></span><span style="display:flex;"><span>	<span style="color:#f00">struct</span> dentry * (*fh_to_dentry)(<span style="color:#f00">struct</span> super_block *sb, <span style="color:#f00">struct</span> fid *fid,
</span></span><span style="display:flex;"><span>			<span style="color:#ee82ee">int</span> fh_len, <span style="color:#ee82ee">int</span> fh_type);
</span></span><span style="display:flex;"><span>	<span style="color:#f00">struct</span> dentry * (*fh_to_parent)(<span style="color:#f00">struct</span> super_block *sb, <span style="color:#f00">struct</span> fid *fid,
</span></span><span style="display:flex;"><span>			<span style="color:#ee82ee">int</span> fh_len, <span style="color:#ee82ee">int</span> fh_type);
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*get_name)(<span style="color:#f00">struct</span> dentry *parent, <span style="color:#ee82ee">char</span> *name,
</span></span><span style="display:flex;"><span>			<span style="color:#f00">struct</span> dentry *child);
</span></span><span style="display:flex;"><span>	<span style="color:#f00">struct</span> dentry * (*get_parent)(<span style="color:#f00">struct</span> dentry *child);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0f0">/* åœ¨é€™ä»¥ä¸‹çš„å‡½æ•¸åªæœ‰ xfs æœ‰å¯¦ä½œ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*commit_metadata)(<span style="color:#f00">struct</span> inode *inode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0f0">/* ä»¥ä¸‹å¹¾å€‹å‡½æ•¸å’Œ pnfs æœ‰é—œï¼Œä½†æˆ‘é‚„ä¸ç¢ºå®šç”¨é€” */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*get_uuid)(<span style="color:#f00">struct</span> super_block *sb, u8 *buf, u32 *len, u64 *offset);
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*map_blocks)(<span style="color:#f00">struct</span> inode *inode, <span style="color:#ee82ee">loff_t</span> offset,
</span></span><span style="display:flex;"><span>			  u64 len, <span style="color:#f00">struct</span> iomap *iomap,
</span></span><span style="display:flex;"><span>			  <span style="color:#ee82ee">bool</span> write, u32 *device_generation);
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> (*commit_blocks)(<span style="color:#f00">struct</span> inode *inode, <span style="color:#f00">struct</span> iomap *iomaps,
</span></span><span style="display:flex;"><span>			     <span style="color:#ee82ee">int</span> nr_iomaps, <span style="color:#f00">struct</span> iattr *iattr);
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div>
<p>ã€€ã€€encode_fh å°‡ä¸€å€‹æª”æ¡ˆçš„ inode è½‰ç‚º fileidï¼Œå¦‚æœ parent ä¸ç‚º NULL çš„è©±ï¼Œå¿…é ˆå°‡è©²æª”æ¡ˆçš„ parent ç›®éŒ„ inode ä¹Ÿä¸€ä¸¦å­˜å…¥ fileidã€‚é€™å€‹å‡½æ•¸æœ‰é è¨­å¯¦ä½œï¼Œæœƒå­˜ 32bits inode number åŠ inode generationï¼Œå¦‚ä»¥ä¸‹çµæ§‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00">struct</span> {
</span></span><span style="display:flex;"><span>	u32 ino;
</span></span><span style="display:flex;"><span>	u32 gen;
</span></span><span style="display:flex;"><span>	u32 parent_ino;
</span></span><span style="display:flex;"><span>	u32 parent_gen;
</span></span><span style="display:flex;"><span>} i32;</span></span></code></pre></div>
<p>ã€€ã€€æˆ‘å€‘å¯ä»¥åœ¨æ ¸å¿ƒçš„ fs/exportfs/expfs.c æ‰¾åˆ°é€™å€‹é è¨­çš„å¯¦ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00">static</span> <span style="color:#ee82ee">int</span> <span style="color:#ff0">export_encode_fh</span>(<span style="color:#f00">struct</span> inode *inode, <span style="color:#f00">struct</span> fid *fid,
</span></span><span style="display:flex;"><span>		<span style="color:#ee82ee">int</span> *max_len, <span style="color:#f00">struct</span> inode *parent)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> len = *max_len;
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">int</span> type = FILEID_INO32_GEN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0f0">// ç¢ºèªæä¾›çš„ç©ºé–“å¤ å¤§ï¼Œä¸å¤ å¤§çš„è©±å‰‡å°‡æ‰€éœ€è¦çš„å¤§å°é€é max_len å›å‚³çµ¦å‘¼å«è€…
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>	<span style="color:#f00">if</span> (parent &amp;&amp; (len &lt; <span style="color:#f60">4</span>)) {
</span></span><span style="display:flex;"><span>		*max_len = <span style="color:#f60">4</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f00">return</span> FILEID_INVALID; <span style="color:#0f0">// 0xFF ä»£è¡¨ç„¡æ•ˆçš„ FILEID
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>	} <span style="color:#f00">else</span> <span style="color:#f00">if</span> (len &lt; <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>		*max_len = <span style="color:#f60">2</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f00">return</span> FILEID_INVALID;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0f0">// å¡«å…¥æª”æ¡ˆçš„ inode number åŠ generation
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>	len = <span style="color:#f60">2</span>;
</span></span><span style="display:flex;"><span>	fid-&gt;i32.ino = inode-&gt;i_ino;
</span></span><span style="display:flex;"><span>	fid-&gt;i32.gen = inode-&gt;i_generation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0f0">// å¦‚æœå‘¼å«è€…æœ‰æä¾› parentï¼Œå‰‡å°‡ parent ä¸€ä½µç·¨å…¥ fileid
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>	<span style="color:#f00">if</span> (parent) {
</span></span><span style="display:flex;"><span>		fid-&gt;i32.parent_ino = parent-&gt;i_ino;
</span></span><span style="display:flex;"><span>		fid-&gt;i32.parent_gen = parent-&gt;i_generation;
</span></span><span style="display:flex;"><span>		len = <span style="color:#f60">4</span>;
</span></span><span style="display:flex;"><span>		type = FILEID_INO32_GEN_PARENT;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	*max_len = len;	<span style="color:#0f0">// å°‡å¯¦éš›ä½¿ç”¨çš„å¤§å°å¾ max_len å›å‚³çµ¦å‘¼å«è€…
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>	<span style="color:#f00">return</span> type;	<span style="color:#0f0">// å›å‚³ç·¨ç¢¼çš„æ–¹å¼
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>}</span></span></code></pre></div>
<p>ã€€ã€€æ¯å€‹æª”æ¡ˆç³»çµ±æ ¹æ“šå…¶éœ€æ±‚å¯è‡ªè¡Œç·¨ç¢¼ä¸åŒçš„å…§å®¹åŠå¤§å°ï¼Œåªè¦èƒ½ç¢ºä¿æ‰¾åˆ°å”¯ä¸€å°æ‡‰çš„æª”æ¡ˆå³å¯ï¼Œä¾‹å¦‚ btrfs è‡³å°‘å¾—å¤šå­˜ root object IDï¼Œå› ç‚ºä»–çš„ inode number åœ¨ä¸åŒ subvolume å…§æ˜¯å¯èƒ½é‡è¤‡çš„ã€‚</p>
<p>ã€€ã€€fh_to_dentry å¯¦ä½œ fileid çš„è§£ç¢¼å·¥ä½œï¼Œçµ¦å®šä¸€å€‹ fileidï¼Œå›å‚³æª”æ¡ˆçš„ dentryï¼Œé€™å€‹å°±æ²’æœ‰é è¨­å¯¦ä½œäº†ï¼Œæ¯å€‹æª”æ¡ˆç³»çµ±è¦æ ¹æ“šä»–çš„ layout æ–¹å¼å–å›å°æ‡‰çš„ dentryï¼Œä¹‹å¾Œ nfs server ä¾¿å¯ä»¥é€éè©² dentry é€²è¡Œæª”æ¡ˆæ“ä½œã€‚</p>
<p>ã€€ã€€fh_to_parent å¯¦ä½œ fileid çš„å¦ä¸€éƒ¨ä»½è§£ç¢¼å·¥ä½œï¼Œå¦‚æœ parent è³‡è¨Šæœ‰å­˜å…¥ fileidï¼Œå‰‡å›å‚³è©² fileid å…§æ‰€ç´€éŒ„çš„ parent dentryã€‚get_parent å‰‡æ˜¯çµ¦å®šä¸€å€‹ dentryï¼Œå›å‚³è©²ä»–çš„ parent dentryã€‚</p>
<p>ã€€ã€€éœ€è¦ parent è³‡è¨Šçš„ä¸»è¦åŸå› æ˜¯ subtree_checkï¼Œç•¶ NFS ä¼ºæœç«¯å•Ÿç”¨ subtree_check å¾Œï¼Œé€²è¡Œæª”æ¡ˆæ“ä½œå‰æœƒå…ˆç¶“éæ¬Šé™çš„æª¢æŸ¥ï¼Œè¦é€²è¡Œæ¬Šé™æª¢æŸ¥ï¼Œå°±å‹¢å¿…è¦èƒ½å–å›è©²æª”æ¡ˆçš„å®Œæ•´è·¯å¾‘ã€‚NFS å–å›å®Œæ•´è·¯å¾‘çš„æ–¹å¼æ˜¯é€é fh_to_parent åŠ get_parent é€™å…©å€‹å‡½æ•¸ï¼Œå…ˆåˆ©ç”¨ fh_to_parent å–å¾—æª”æ¡ˆçš„ parent dentryï¼Œå†é€é get_parent ä¸€è·¯æ‰¾å›æ ¹ç›®éŒ„ã€‚</p>
<p>ã€€ã€€å·²ç¶“æœ‰ get_parent å‡½æ•¸äº†ç‚ºä½•é‚„è¦ fh_to_parent å‘¢ï¼Ÿç†Ÿæ‚‰ ext4 æª”æ¡ˆç³»çµ±æ¶æ§‹è€…å°±æœƒçŸ¥é“ï¼Œåªæœ‰ä¸€å€‹æª”æ¡ˆçš„ inode number æ˜¯æ²’è¾¦æ³•ç›´æ¥å–å¾—ä»–æ‰€åœ¨çš„ç›®éŒ„çš„ï¼Œæ‰€ä»¥æ‰éœ€è¦åœ¨ç·¨ç¢¼æ™‚å°‡ä»–çš„ parent ä¸€ä¸¦ç·¨å…¥ã€‚ä½†å¦‚æœå·²çŸ¥ä¸€å€‹ç›®éŒ„ï¼Œæª”æ¡ˆç³»çµ±å°±å¯ä»¥é€é &lsquo;..&rsquo; ä¸€è·¯æ‰¾å›æ ¹ç›®éŒ„äº†ã€‚</p>

      <div class="share-icons d-flex justify-content-center d-print-none">
        <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.jaycetyle.com%2f2018%2f09%2fnfs-filehandle%2f&text=Linux%20NFS%20filehandle%20%e7%ad%86%e8%a8%98&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.jaycetyle.com%2f2018%2f09%2fnfs-filehandle%2f&t=Linux%20NFS%20filehandle%20%e7%ad%86%e8%a8%98" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.jaycetyle.com%2f2018%2f09%2fnfs-filehandle%2f&title=Linux%20NFS%20filehandle%20%e7%ad%86%e8%a8%98&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
      </div>
    </div>

    

    
    
<div id="giscus-comments">
  <script src="https://giscus.app/client.js"
          data-repo="jaycetyle/jaycetyle.github.io"
          data-repo-id="MDEwOlJlcG9zaXRvcnkxMTYyNTQ2Mjk"
          data-category="Comments"
          data-category-id="DIC_kwDOBu3npc4CouiB"
          data-mapping="pathname"
          data-theme="preferred_color_scheme"
          data-lang="zh-TW"
          crossorigin="anonymous"
          async>
  </script>
</div>
  </div>
  <div class="sidebar d-print-none d-none d-xl-block">
  <h5 class="mt-4 post-title">Recent Posts</h5>
  <ul class="mt-2 pl-4">
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2025/04/gpt-dark-mode/">å…¨éƒ¨è¤‡è£½è²¼ä¸Šï¼æˆ‘ç”¨ Chatgpt å¹«ç¶²ç«™åŠ äº†ä¸€å€‹æš—è‰²æ¨¡å¼</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2021/10/linux-fio-tips/">Linux fio æ¸¬è©¦åƒæ•¸çš„çœ‰çœ‰è§’è§’</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2021/10/kprobe-userspace-tool/">Kprobe Userspace Tool ä½¿ç”¨ç­†è¨˜</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2019/12/linux-bug-on-case-study/">Linux Kernel BUG_ON å‚¾å°è¨Šæ¯åˆ†æåŠæ¡ˆä¾‹åˆ†äº«</a></li>
    
    <li class="mt-2 mb-2"><a href="https://blog.jaycetyle.com/2019/11/passing-smart-pointer/">[C&#43;&#43;] å¹¾ç¨®åœ¨å‡½æ•¸å‚³é Smart Pointer çš„æ–¹å¼æ•´ç†</a></li>
    
  </ul>
  <h5 class="mt-4 text-capitalize post-title">Tags</h5>
  <ul class="mt-2 pl-4">
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/c/c&#43;&#43;/'>
      C/C&#43;&#43;
      <span class="badge badge-pill badge-secondary">11</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/ubuntu-%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/'>
      Ubuntu ä½œæ¥­ç³»çµ±
      <span class="badge badge-pill badge-secondary">7</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/linux-kernel/'>
      Linux Kernel
      <span class="badge badge-pill badge-secondary">6</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/'>
      é–‹ç™¼ç’°å¢ƒ
      <span class="badge badge-pill badge-secondary">5</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/'>
      ç‰ˆæœ¬æ§åˆ¶
      <span class="badge badge-pill badge-secondary">4</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E7%B6%B2%E7%AB%99%E6%9E%B6%E8%A8%AD/'>
      ç¶²ç«™æ¶è¨­
      <span class="badge badge-pill badge-secondary">4</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E9%96%92%E8%81%8A/'>
      é–’èŠ
      <span class="badge badge-pill badge-secondary">4</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E6%A8%B9%E8%8E%93%E6%B4%BE/'>
      æ¨¹è“æ´¾
      <span class="badge badge-pill badge-secondary">3</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/ai/'>
      AI
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/c%23/'>
      C#
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/linux-system-performance/'>
      Linux System Performance
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/nas-%E8%88%87%E8%B3%87%E6%96%99%E5%82%99%E4%BB%BD/'>
      NAS èˆ‡è³‡æ–™å‚™ä»½
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/python/'>
      Python
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
    <li class="mt-2 mb-2">
      <a href='https://blog.jaycetyle.com//tags/%E5%B7%A5%E5%85%B7%E8%BB%9F%E9%AB%94/'>
      å·¥å…·è»Ÿé«”
      <span class="badge badge-pill badge-secondary">1</span>
      </a>
    </li>
    
  </ul>
</div>

        </div>

        <footer class="mt-auto footer d-print-none">
            <div class="container-fluid">
                <div class="d-flex col-xl-12 justify-content-center">
                    <div>Â© 2019<a href="https://blog.jaycetyle.com/about/"> Lin Chieh ( Jayce )</a>. Powered by <a href="https://gohugo.io/">Hugo</a> using <a href='https://www.mattbutton.com'>Matt Button</a>'s <a href='https://github.com/mattbutton/silhouette-hugo'>Silhouette Hugo</a> theme.</div>
                </div>
                </hr>
                <div class="d-flex justify-content-center icons">
                    <a class="py-2 px-2" href="https://www.linkedin.com/in/chieh-lin-569430a9/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href="https://github.com/jaycetyle/"><i class="fab fa-github"></i></a>
<a class="py-2 px-2" href='https://blog.jaycetyle.com/index.xml'><i class="fas fa-rss"></i></a>

                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-1ZFSFPEZG5"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-1ZFSFPEZG5');
        }
      </script>
    </body>
</html>
